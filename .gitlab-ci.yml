stages:
  - build
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ''
  SERVER_HOST: j12e102.p.ssafy.io
  PEM_FILE: J12E102T.pem
  BACKEND_IMAGE: busankim/ssafyproject:backend
  FRONTEND_IMAGE: busankim/ssafyproject:frontend

services:
  - docker:dind

default:
  image: docker:latest
  before_script:
    - docker info

backend-build:
  stage: build
  script:
    - docker build -t $BACKEND_IMAGE ./be
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/be-infra'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

frontend-build:
  stage: build
  script:
    - echo "VITE_BASE_URL=https://j12e102.p.ssafy.io/api" > ./fe/.env
    - docker build -t $FRONTEND_IMAGE ./fe
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/fe-infra'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

backend-push:
  stage: push
  script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - docker push $BACKEND_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/be-infra'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

frontend-push:
  stage: push
  script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - docker push $FRONTEND_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/fe-infra'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

backend-deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > $PEM_FILE
    - chmod 400 $PEM_FILE
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh -i $PEM_FILE ubuntu@$SERVER_HOST "
      cd ~/project &&
      sudo docker pull $BACKEND_IMAGE &&
      sudo docker-compose up -d backend
      "
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/be-infra'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

frontend-deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > $PEM_FILE
    - chmod 400 $PEM_FILE
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh -i $PEM_FILE ubuntu@$SERVER_HOST "
      cd ~/project &&
      sudo docker pull $FRONTEND_IMAGE &&
      sudo docker-compose up -d frontend
      "
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'feature/fe-infra'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra
