stages:
 - build
 - push
 - deploy

variables:
 DOCKER_DRIVER: overlay2
 DOCKER_TLS_CERTDIR: ""

services:
 - docker:dind

default:
 image: docker:latest
 before_script:
   - docker info

build:
 stage: build
 script:
   - docker build -t busankim/ssafyproject:backend ./be
 only:
   - develop
   - feature/be-infra
 tags:
   - ssafy-second-infra

push:
 stage: push
 script:
   - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
   - docker push busankim/ssafyproject:backend
 only:
   - develop
   - feature/be-infra
 tags:
   - ssafy-second-infra

deploy:
  stage: deploy
  script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d | head -n 5  # 키의 처음 5줄 출력
  only:
    - develop
    - feature/be-infra
  tags:
    - ssafy-second-infra
