stages:
  - verify
  - build
  - push
  - deploy

variables:
  # ðŸ†• Docker í˜¸ìŠ¤íŠ¸ ë° TLS ì„¤ì • ì¶”ê°€
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ''
  DOCKER_DRIVER: overlay2
  SERVER_HOST: j12e102.p.ssafy.io
  PEM_FILE: J12E102T.pem
  BACKEND_IMAGE: busankim/ssafyproject:backend
  FRONTEND_IMAGE: busankim/ssafyproject:frontend

services:
  - docker:dind

default:
  image: docker:latest
  # ðŸ†• Docker ì„œë¹„ìŠ¤ ëª…ì‹œì  ì¶”ê°€
  services:
    - docker:dind
  # ðŸ†• Docker CLI ì„¤ì¹˜ ë° ì •ë³´ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
  before_script:
    - apk add --no-cache docker-cli
    - docker info

# ë°±ì—”ë“œ ê²€ì¦ ë‹¨ê³„ - MRìš©
backend-verify:
  stage: verify
  image: gradle:8.13-jdk17
  # ðŸ†• Docker ì„œë¹„ìŠ¤ ì¶”ê°€
  services:
    - docker:dind
  script:
    - cd be
    - gradle clean build -x test
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'develop'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

# í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦ ë‹¨ê³„ - MRìš©
frontend-verify:
  stage: verify
  image: node:20
  # ðŸ†• Docker ì„œë¹„ìŠ¤ ì¶”ê°€
  services:
    - docker:dind
  script:
    - cd fe
    - npm ci
    - npm run build
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'develop'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

# ë°±ì—”ë“œ ë¹Œë“œ - develop ë¸Œëžœì¹˜ìš©
backend-build:
  stage: build
  needs:
    - backend-verify
  script:
    - docker build -t $BACKEND_IMAGE ./be
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

# í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ - develop ë¸Œëžœì¹˜ìš©
frontend-build:
  stage: build
  needs:
    - frontend-verify
  script:
    - echo "VITE_BASE_URL=${VITE_BASE_URL}" > ./fe/.env
    - echo "VITE_TOKEN_REFRESH_INTERVAL=${VITE_TOKEN_REFRESH_INTERVAL}" >> ./fe/.env
    - echo "VITE_TOKEN_EXPIRY_THRESHOLD=${VITE_TOKEN_EXPIRY_THRESHOLD}" >> ./fe/.env
    - docker build -t $FRONTEND_IMAGE ./fe
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

backend-push:
  stage: push
  needs:
    - backend-build
  script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - docker push $BACKEND_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

frontend-push:
  stage: push
  needs:
    - frontend-build
  script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - docker push $FRONTEND_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

backend-deploy:
  stage: deploy
  needs:
    - backend-push
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash docker-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > $PEM_FILE
    - chmod 400 $PEM_FILE
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh -i $PEM_FILE ubuntu@$SERVER_HOST "
      cd ~/project &&
      sudo docker pull $BACKEND_IMAGE &&
      sudo docker-compose up -d backend
      "
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - be/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra

frontend-deploy:
  stage: deploy
  needs:
    - frontend-push
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash docker-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > $PEM_FILE
    - chmod 400 $PEM_FILE
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh -i $PEM_FILE ubuntu@$SERVER_HOST "
      cd ~/project &&
      sudo docker pull $FRONTEND_IMAGE &&
      sudo docker-compose up -d frontend
      "
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
      changes:
        - fe/**/*
        - .gitlab-ci.yml
  tags:
    - ssafy-second-infra
